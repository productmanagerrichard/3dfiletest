<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fitz Frames – 3D Viewer</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer@3.4.0/dist/model-viewer.min.js"></script>
  <style>
    :root { --bg:#0e1116; --card:#121720; --text:#e8e8e8; --muted:#9aa4b2; }
    html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text)}
    .wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;gap:14px;padding:24px;max-width:1100px;margin:0 auto}
    h1{font-size:20px;font-weight:650;margin:0;text-align:center}
    model-viewer{width:100%;height:72vh;background:linear-gradient(180deg,#0f1320,#0b0e16);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .controls{display:flex;gap:16px;flex-wrap:wrap;align-items:center;justify-content:center}
    .group{display:flex;align-items:center;gap:10px;background:var(--card);padding:10px 12px;border-radius:12px;border:1px solid #1e2533}
    .label{font-size:12px;color:var(--muted);margin-right:2px}
    .swatch{width:28px;height:28px;border-radius:999px;border:2px solid rgba(255,255,255,.25);cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.35)}
    .swatch[aria-selected="true"]{outline:2px solid #fff;outline-offset:2px}
    .chip{font-size:12px;line-height:1;border:1px solid #2a3344;padding:6px 8px;border-radius:999px;cursor:pointer;background:transparent;color:var(--text)}
    .chip[aria-selected="true"]{background:#1b2230}
    footer{font-size:12px;color:var(--muted);text-align:center;margin-top:2px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Fitz Frames – Brimmer</h1>

    <model-viewer
      id="viewer"
      src="/models/brimmer.glb"
      alt="Fitz Frames – Brimmer"
      camera-controls
      touch-action="pan-y"
      exposure="1"
      environment-image="neutral"
      shadow-intensity="0.4"
      shadow-softness="0.7"
      auto-rotate
      rotation-per-second="25deg">
    </model-viewer>

    <div class="controls">
      <!-- Frame colors -->
      <div class="group" id="frameGroup" role="radiogroup" aria-label="Frame color">
        <span class="label">Frame:</span>
        <button class="swatch" data-hex="#dddddd" aria-label="Light Gray" aria-selected="true" style="background:#dddddd"></button>
        <button class="swatch" data-hex="#cb263a" aria-label="Crimson" style="background:#cb263a"></button>
      </div>

      <!-- Lens types -->
      <div class="group" id="lensGroup" role="radiogroup" aria-label="Lens type">
        <span class="label">Lenses:</span>
        <button class="chip" data-type="clear"      aria-selected="true">Clear</button>
        <button class="chip" data-type="blue">Blue</button>
        <button class="chip" data-type="sunglass">Sunglasses (med)</button>
        <button class="chip" data-type="mirror">Reflective</button>
      </div>
    </div>

    <footer>Drag to rotate · Two-finger drag to pan · Pinch to zoom</footer>
  </div>

  <script>
    const mv = document.getElementById('viewer');
    const frameGroup = document.getElementById('frameGroup');
    const lensGroup  = document.getElementById('lensGroup');

    // --- Utilities ---
    function hexToLinearRGBA(hex){
      const m = /^#?([a-f0-9]{2})([a-f0-9]{2})([a-f0-9]{2})$/i.exec(hex);
      if(!m) return [1,1,1,1];
      const srgb = [parseInt(m[1],16), parseInt(m[2],16), parseInt(m[3],16)].map(v=>v/255);
      const toLinear = c => (c <= 0.04045) ? c/12.92 : Math.pow((c+0.055)/1.055, 2.4);
      const lin = srgb.map(toLinear);
      return [lin[0], lin[1], lin[2], 1.0];
    }
    function selectInGroup(group, el){
      [...group.querySelectorAll('[aria-selected]')].forEach(b=>b.setAttribute('aria-selected','false'));
      el.setAttribute('aria-selected','true');
    }
    function isLens(mat){
      const n = (mat.name||'').toLowerCase();
      return n.includes('lens') || n.includes('glass');
    }

    // --- Frame color ---
    function applyFrameColor(hex){
      const color = hexToLinearRGBA(hex);
      const model = mv.model; if(!model || !color) return;
      for(const mat of model.materials){
        if (isLens(mat)) continue;
        try {
          mat.pbrMetallicRoughness.setBaseColorFactor(color);
        } catch {}
      }
    }

    // --- Lens looks (simulation without requiring transmission extension) ---
    // These are tuned to be visibly different even if your GLB's lens material is opaque.
    const LENS_PRESETS = {
      clear: {
        baseHex: '#ffffff', alpha: 1.0, roughness: 0.05, metallic: 0.0, mode: 'OPAQUE'
      },
      blue: {
        baseHex: '#8db6ff', alpha: 1.0, roughness: 0.08, metallic: 0.0, mode: 'OPAQUE'
      },
      sunglass: {
        baseHex: '#2a2f2a', alpha: 1.0, roughness: 0.12, metallic: 0.0, mode: 'BLEND' // darker surface + slight blend
      },
      mirror: {
        baseHex: '#c9c9c9', alpha: 1.0, roughness: 0.02, metallic: 1.0, mode: 'OPAQUE' // high metal, low roughness => reflective feel
      }
    };

    function applyLensPreset(kind){
      const model = mv.model; if(!model) return;
      const preset = LENS_PRESETS[kind] || LENS_PRESETS.clear;
      const base = hexToLinearRGBA(preset.baseHex);

      for(const mat of model.materials){
        if(!isLens(mat)) continue;
        try {
          mat.pbrMetallicRoughness.setBaseColorFactor(base);
          mat.pbrMetallicRoughness.setRoughnessFactor(preset.roughness);
          mat.pbrMetallicRoughness.setMetallicFactor(preset.metallic);
          mat.setAlphaMode(preset.mode); // BLEND for tinted look if your mesh allows
          mat.setDoubleSided(true);
        } catch {}
      }

      // Tip: reflective looks pop more with an HDR environment map.
      // You can replace 'environment-image="neutral"' with a studio HDR URL for stronger reflections.
    }

    // --- Init + event wiring ---
    mv.addEventListener('load', () => {
      const fSel = frameGroup.querySelector('[aria-selected="true"]');
      if(fSel) applyFrameColor(fSel.dataset.hex);

      const lSel = lensGroup.querySelector('[aria-selected="true"]');
      if(lSel) applyLensPreset(lSel.dataset.type);
    });

    frameGroup.addEventListener('click', (e)=>{
      const btn = e.target.closest('.swatch'); if(!btn) return;
      selectInGroup(frameGroup, btn);
      applyFrameColor(btn.dataset.hex);
    });

    lensGroup.addEventListener('click', (e)=>{
      const btn = e.target.closest('.chip'); if(!btn) return;
      selectInGroup(lensGroup, btn);
      applyLensPreset(btn.dataset.type);
    });
  </script>
</body>
</html>
